log_format json_combined escape=json
'{'
  '"@timestamp":"$time_iso8601",'
  '"remote_addr":"$remote_addr",'
  '"x_forwarded_for":"$http_x_forwarded_for",'
  '"request_method":"$request_method",'
  '"request_uri":"$request_uri",'
  '"status":$status,'
  '"body_bytes_sent":$body_bytes_sent,'
  '"request_time":$request_time,'
  '"upstream_addr":"$upstream_addr",'
  '"upstream_status":"$upstream_status",'
  '"upstream_response_time":"$upstream_response_time",'
  '"host":"$host",'
  '"http_referer":"$http_referer",'
  '"http_user_agent":"$http_user_agent",'
  '"request_id":"$req_id"'
'}';

map $http_x_request_id $req_id {
  default $http_x_request_id;
  ""      $request_id;
}

server {
  listen 8081;
  server_name _;

  access_log /dev/stdout json_combined;
  error_log  /dev/stderr warn;

  add_header Access-Control-Allow-Origin "*" always;
  add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
  add_header Access-Control-Allow-Headers "Accept-Language, Content-Type, Authorization, X-Request-ID" always;
  add_header Access-Control-Expose-Headers "Content-Length, Content-Type, X-Request-ID" always;

  if ($request_method = OPTIONS) {
    return 204;
  }

  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Request-ID $req_id;

    # --- Keycloak token ---
    # /login  ->  http://keycloak:8080/realms/myrealm/protocol/openid-connect/token
    location = /login {
        proxy_pass http://keycloak:8080/realms/myrealm/protocol/openid-connect/token;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- tester_service ---
    location /solutions/ {
        proxy_pass http://tester_service:8001;
        proxy_set_header Host $host;
    }

    location /languages/ {
        proxy_pass http://tester_service:8001;
        proxy_set_header Host $host;
    }

    # --- content_service ---
    location / {
        proxy_pass http://content_service:8000;
        proxy_set_header Host $host;
    }
}
